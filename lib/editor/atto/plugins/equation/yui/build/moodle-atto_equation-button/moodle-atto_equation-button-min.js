<<<<<<< HEAD
YUI.add("moodle-atto_equation-button",function(e,t){var n="atto_equation",r="atto_equation",i={EQUATION_TEXT:"atto_equation_equation",EQUATION_PREVIEW:"atto_equation_preview",SUBMIT:"atto_equation_submit",LIBRARY:"atto_equation_library",LIBRARY_GROUPS:"atto_equation_groups",LIBRARY_GROUP_PREFIX:"atto_equation_group"},s={LIBRARY:"."+i.LIBRARY,LIBRARY_GROUP:"."+i.LIBRARY_GROUPS+" > div > div",EQUATION_TEXT:"."+i.EQUATION_TEXT,EQUATION_PREVIEW:"."+i.EQUATION_PREVIEW,SUBMIT:"."+i.SUBMIT,LIBRARY_BUTTON:"."+i.LIBRARY+" button"},o={START:"\\(",END:"\\)"},u={FORM:'<form class="atto_form">{{{library}}}<label for="{{elementid}}_{{CSS.EQUATION_TEXT}}">{{{get_string "editequation" component texdocsurl}}}</label><textarea class="fullwidth {{CSS.EQUATION_TEXT}}" id="{{elementid}}_{{CSS.EQUATION_TEXT}}" rows="8"></textarea><br/><label for="{{elementid}}_{{CSS.EQUATION_PREVIEW}}">{{get_string "preview" component}}</label><div describedby="{{elementid}}_cursorinfo" class="well well-small p-1 fullwidth {{CSS.EQUATION_PREVIEW}}" id="{{elementid}}_{{CSS.EQUATION_PREVIEW}}"></div><div id="{{elementid}}_cursorinfo">{{get_string "cursorinfo" component}}</div><div class="mdl-align"><br/><button class="btn btn-secondary {{CSS.SUBMIT}}">{{get_string "saveequation" component}}</button></div></form>',LIBRARY:'<div class="{{CSS.LIBRARY}}"><ul class="root nav nav-tabs mb-1" role="tablist">{{#each library}}<li  class="nav-item"><a class="nav-link" href="#{{../elementid}}_{{../CSS.LIBRARY_GROUP_PREFIX}}_{{@key}}"  data-target="#{{../elementidescaped}}_{{../CSS.LIBRARY_GROUP_PREFIX}}_{{@key}}" role="tab" data-toggle="tab">{{get_string groupname ../component}}</a></li>{{/each}}</ul><div class="tab-content mb-1 {{CSS.LIBRARY_GROUPS}}">{{#each library}}<div data-medium-type="{{CSS.LINK}}" class="tab-pane" id="{{../elementid}}_{{../CSS.LIBRARY_GROUP_PREFIX}}_{{@key}}"><div role="toolbar">{{#split "\n" elements}}<button class="btn btn-secondary" tabindex="-1" data-tex="{{this}}"aria-label="{{this}}" title="{{this}}">{{../../DELIMITERS.START}}{{this}}{{../../DELIMITERS.END}}</button>{{/split}}</div></div>{{/each}}</div></div>'};e.namespace("M.atto_equation").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_lastCursorPos:0,_content:null,_sourceEquation:null,_groupFocus:null,_equationPatterns:[/\$\$([\S\s]+?)\$\$/,/\\\(([\S\s]+?)\\\)/,/\\\[([\S\s]+?)\\\]/,/\[tex\]([\S\s]+?)\[\/tex\]/],initializer:function(){this._groupFocus={},this.get("texfilteractive")&&(this.addButton({icon:"e/math",callback:this._displayDialogue}),this.get("host").on("atto:selectionchanged",function(){this._resolveEquation()?this.highlightButtons():this.unHighlightButtons()},this),this.editor.all("tex").each(function(t){var n=e.Node.create("<span>"+o.START+" "+t.get("text")+" "+o.END+"</span>");t.replace(n)}))},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;var e=this._resolveEquation(),t=this.getDialogue({headerContent:M.util.get_string("pluginname",n),focusAfterHide:!0,width:600,focusOnShowSelector:s.EQUATION_TEXT}),r=this._getDialogueContent();t.set("bodyContent",r),r.one(".nav-item:first-child .nav-link").getDOMNode().click(),t.show(),require(["core/event"],function(e){e.notifyFilterContentUpdated(t.get("boundingBox").getDOMNode())}),e&&r.one(s.EQUATION_TEXT).set("text",e),this._updatePreview(!1)},_resolveEquation:function(){var t=this.get("host").getSelectionParentNode(),n=this.get("host").getSelection(),r,i=!1;return this.get("host").isActive()?t?!n||n.length===0?!1:(this.sourceEquation=null,n=n[0],r=e.one(t).get("text"),e.Array.find(this._equationPatterns,function(t){var s=r.match(new RegExp(t.source,"g"));if(s&&s.length)return e.Array.find(s,function(e){var s=0;while(r.indexOf(e,s)!==-1){var o=r.indexOf(e,s),u=o+e.length,a=n.startOffset>=o&&n.startOffset<u,f=n.endOffset<=u&&n.endOffset>o;if(a&&f){var l=e.match(t);if(l&&l.length){var c=r.indexOf(l[1],o),h=c+l[1].length;return i=l[1],this.sourceEquation={startOuterPosition:o,endOuterPosition:u,outerMatch:e,startInnerPosition:c,endInnerPosition:h,innerMatch:l},!0}}s=u}},this)},this),i!==!1&&(i=i.trim()),i):!1:!1},_setEquation:function(t){var n,r,i,s,u,a;u=this.get("host"),t.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),n=t.currentTarget.ancestor(".atto_form").one("textarea"),s=n.get("value"),s!==""&&(u.setSelection(this._currentSelection),this.sourceEquation?(r=e.one(u.getSelectionParentNode()),i=r.get("text"),s=" "+s+" ",a=i.slice(0,this.sourceEquation.startInnerPosition)+s+i.slice(this.sourceEquation.endInnerPosition),r.set("text",a)):(s=o.START+" "+s+" "+o.END,u.insertContentAtFocusPoint(s)),this.markUpdated())},_throttle:function(e,t){var n=null;return function(){var r=this,i=arguments;clearTimeout(n),n=setTimeout(function(){e.apply(r,i)},t)}},_updatePreview:function(t){var n=this._content.one(s.EQUATION_TEXT),r=n.get("value"),i,u=n.get("selectionStart"),a="",f="\\Downarrow ",l,c;t&&t.preventDefault(),u||(u=0);while(r.charAt(u)==="\\"&&u>=0)u-=1;l=/[a-zA-Z\{]/;if(u!==0&&r.charAt(u-1)!="{")while(l.test(r.charAt(u))&&u<r.length&&l.test(r.charAt(u-1)))u+=1;this._lastCursorPos=u,r=a+r.substring(0,u)+f+r.substring(u),r=o.START+" "+r+" "+o.END,i=M.cfg.wwwroot+"/lib/editor/atto/plugins/equation/ajax.php",c={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",text:r},e.io(i,{context:this,data:c,timeout:500,on:{complete:this._loadPreview}})},_loadPreview:function(e,t){var n=this._content.one(s.EQUATION_PREVIEW);t.status===200&&(n.setHTML(t.responseText),require(["core/event"],function(e){e.notifyFilterContentUpdated(n.getDOMNode())}))},_getDialogueContent:function(){var t=this._getLibraryContent(),r=this._throttle(this._updatePreview,500),o=e.Handlebars.compile(u.FORM);return this._content=e.Node.create(o({elementid:this.get("host").get("elementid"),component:n,library:t,texdocsurl:this.get("texdocsurl"),CSS:i})),this._content.all(s.LIBRARY_GROUP).each(function(
e){this._setGroupTabFocus(e,e.one("button")),e.all("button a").setAttribute("tabindex","-1")},this),this._content.delegate("key",this._groupNavigation,"down:37,39",s.LIBRARY_BUTTON,this),this._content.one(s.SUBMIT).on("click",this._setEquation,this),this._content.one(s.EQUATION_TEXT).on("valuechange",r,this),this._content.one(s.EQUATION_TEXT).on("mouseup",r,this),this._content.one(s.EQUATION_TEXT).on("keyup",r,this),this._content.delegate("click",this._selectLibraryItem,s.LIBRARY_BUTTON,this),this._content},_groupNavigation:function(e){e.preventDefault();var t=e.currentTarget,n=t.get("parentNode"),r=n.all("button"),i=e.keyCode!==37?1:-1,s=r.indexOf(t),o;s<0&&(s=0),s+=i,s<0?s=r.size()-1:s>=r.size()&&(s=0),o=r.item(s),this._setGroupTabFocus(n,o),o.focus()},_setGroupTabFocus:function(e,t){var n=e.generateID();typeof this._groupFocus[n]!="undefined"&&this._groupFocus[n].setAttribute("tabindex","-1"),this._groupFocus[n]=t,t.setAttribute("tabindex",0),e.setAttribute("aria-activedescendant",t.generateID())},_selectLibraryItem:function(e){var t=e.currentTarget.getAttribute("data-tex"),n,r,i,s=0;e.preventDefault(),this._setGroupTabFocus(e.currentTarget.get("parentNode"),e.currentTarget),i=e.currentTarget.ancestor(".atto_form").one("textarea"),n=i.get("value"),r=n.substring(0,this._lastCursorPos),r.charAt(r.length-1)!==" "&&(r+=" "),r+=t,s=r.length,n.charAt(this._lastCursorPos)!==" "&&(r+=" "),r+=n.substring(this._lastCursorPos,n.length),i.set("value",r),i.focus();var o=i.getDOMNode();if(typeof o.selectionStart=="number")o.selectionStart=o.selectionEnd=s;else if(typeof o.createTextRange!="undefined"){var u=o.createTextRange();u.moveToPoint(s),u.select()}this._updatePreview(!1)},_getLibraryContent:function(){var t=e.Handlebars.compile(u.LIBRARY),r=this.get("library"),s="";e.Handlebars.registerHelper("split",function(e,t,n){var r,i,s;if(typeof e=="undefined"||typeof t=="undefined")return"";s="",r=t.trim().split(e);while(r.length>0)i=r.shift().trim(),s+=n.fn(i);return s}),s=t({elementid:this.get("host").get("elementid"),elementidescaped:this._escapeQuerySelector(this.get("host").get("elementid")),component:n,library:r,CSS:i,DELIMITERS:o});var a=M.cfg.wwwroot+"/lib/editor/atto/plugins/equation/ajax.php",f={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",text:s},l=e.io(a,{sync:!0,data:f,method:"POST"});return l.status===200&&(s=l.responseText),s},_escapeQuerySelector:function(e){return e.replace(/(:|\.|\[|\]|,|=|@)/g,"\\$1")}},{ATTRS:{texfilteractive:{value:!1},contextid:{value:null},library:{value:{}},texdocsurl:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","moodle-core-event","io","event-valuechange","tabview","array-extras"]});
=======
YUI.add("moodle-atto_equation-button",function(r,t){var s="atto_equation",u={EQUATION_TEXT:"atto_equation_equation",EQUATION_PREVIEW:"atto_equation_preview",SUBMIT:"atto_equation_submit",LIBRARY:"atto_equation_library",LIBRARY_GROUPS:"atto_equation_groups",LIBRARY_GROUP_PREFIX:"atto_equation_group"},l={LIBRARY:"."+u.LIBRARY,LIBRARY_GROUP:"."+u.LIBRARY_GROUPS+" > div > div",EQUATION_TEXT:"."+u.EQUATION_TEXT,EQUATION_PREVIEW:"."+u.EQUATION_PREVIEW,SUBMIT:"."+u.SUBMIT,LIBRARY_BUTTON:"."+u.LIBRARY+" button"},c={START:"\\(",END:"\\)"},n='<form class="atto_form">{{{library}}}<label for="{{elementid}}_{{CSS.EQUATION_TEXT}}">{{{get_string "editequation" component texdocsurl}}}</label><textarea class="fullwidth text-ltr {{CSS.EQUATION_TEXT}}" id="{{elementid}}_{{CSS.EQUATION_TEXT}}" rows="8"></textarea><br/><label for="{{elementid}}_{{CSS.EQUATION_PREVIEW}}">{{get_string "preview" component}}</label><div describedby="{{elementid}}_cursorinfo" class="border rounded bg-light p-1 fullwidth {{CSS.EQUATION_PREVIEW}}" id="{{elementid}}_{{CSS.EQUATION_PREVIEW}}"></div><div id="{{elementid}}_cursorinfo">{{get_string "cursorinfo" component}}</div><div class="mdl-align"><br/><button class="btn btn-secondary {{CSS.SUBMIT}}">{{get_string "saveequation" component}}</button></div></form>',d='<div class="{{CSS.LIBRARY}}"><ul class="root nav nav-tabs mb-1" role="tablist">{{#each library}}<li  class="nav-item"><a class="nav-link{{#active}} active{{/active}}" {{#active}}aria-selected="true"{{/active}}{{^active}}aria-selected="false" tabindex="-1"{{/active}} href="#{{../elementid}}_{{../CSS.LIBRARY_GROUP_PREFIX}}_{{@key}}"  data-target="#{{../elementidescaped}}_{{../CSS.LIBRARY_GROUP_PREFIX}}_{{@key}}" role="tab" data-toggle="tab">{{get_string groupname ../component}}</a></li>{{/each}}</ul><div class="tab-content mb-1 {{CSS.LIBRARY_GROUPS}}">{{#each library}}<div data-medium-type="{{CSS.LINK}}" class="tab-pane{{#active}} active{{/active}}" id="{{../elementid}}_{{../CSS.LIBRARY_GROUP_PREFIX}}_{{@key}}"><div role="toolbar">{{#split "\n" elements}}<button class="btn btn-secondary" tabindex="-1" data-tex="{{this}}"aria-label="{{this}}" title="{{this}}">{{../../DELIMITERS.START}}{{this}}{{../../DELIMITERS.END}}</button>{{/split}}</div></div>{{/each}}</div></div>';r.namespace("M.atto_equation").Button=r.Base.create("button",r.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_lastCursorPos:0,_content:null,_sourceEquation:null,_groupFocus:null,_equationPatterns:[/\$\$([\S\s]+?)\$\$/,/\\\(([\S\s]+?)\\\)/,/\\\[([\S\s]+?)\\\]/,/\[tex\]([\S\s]+?)\[\/tex\]/],initializer:function(){this._groupFocus={},this.get("texfilteractive")&&(this.addButton({icon:"e/math",callback:this._displayDialogue}),this.get("host").on("atto:selectionchanged",function(){this._resolveEquation()?this.highlightButtons():this.unHighlightButtons()},this),this.editor.all("tex").each(function(t){var e=r.Node.create("<span>"+c.START+" "+t.get("text")+" "+c.END+"</span>");t.replace(e)}))},_displayDialogue:function(){var t,e,i;this._currentSelection=this.get("host").getSelection(),!1!==this._currentSelection&&(t=this._resolveEquation(),e=this.getDialogue({headerContent:M.util.get_string("pluginname",s),focusAfterHide:!0,width:600,focusOnShowSelector:l.LIBRARY_BUTTON}),i=this._getDialogueContent(),e.set("bodyContent",i),e.show(),require(["core/event"],function(t){t.notifyFilterContentUpdated(e.get("boundingBox").getDOMNode())}),t&&i.one(l.EQUATION_TEXT).set("text",t),this._updatePreview(!1))},_resolveEquation:function(){var c,t=this.get("host").getSelectionParentNode(),d=this.get("host").getSelection(),h=!1;return!!this.get("host").isActive()&&(!!t&&(!(!d||0===d.length)&&(this.sourceEquation=null,d=d[0],c=r.one(t).get("text"),r.Array.find(this._equationPatterns,function(l){var t=c.match(new RegExp(l.source,"g"));if(t&&t.length)return r.Array.find(t,function(t){for(var e,i,n,o,a,s,r,u=0;-1!==c.indexOf(t,u);){if(i=(e=c.indexOf(t,u))+t.length,n=d.startOffset>=e&&d.startOffset<i,o=d.endOffset<=i&&d.endOffset>e,n&&o&&(a=t.match(l))&&a.length)return r=(s=c.indexOf(a[1],e))+a[1].length,h=a[1],this.sourceEquation={startOuterPosition:e,endOuterPosition:i,outerMatch:t,startInnerPosition:s,endInnerPosition:r,innerMatch:a},!0;u=i}},this)},this),!1!==h&&(h=h.trim()),h)))},_setEquation:function(t){var e,i,n,o,a;o=this.get("host"),t.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),""!==(n=t.currentTarget.ancestor(".atto_form").one("textarea").get("value"))&&(o.setSelection(this._currentSelection),this.sourceEquation?(n=" "+n+" ",a=(i=(e=r.one(o.getSelectionParentNode())).get("text")).slice(0,this.sourceEquation.startInnerPosition)+n+i.slice(this.sourceEquation.endInnerPosition),e.set("text",a)):(n=c.START+" "+n+" "+c.END,o.insertContentAtFocusPoint(n)),this.markUpdated())},_throttle:function(i,n){var o=null;return function(){var t=this,e=arguments;clearTimeout(o),o=setTimeout(function(){i.apply(t,e)},n)}},_updatePreview:function(t){var e,i,n,o=this._content.one(l.EQUATION_TEXT),a=o.get("value"),s=o.get("selectionStart");for(t&&t.preventDefault(),s=s||0;"\\"===a.charAt(s)&&0<=s;)--s;if(i=/[a-zA-Z\{]/,0!==s&&"{"!=a.charAt(s-1))for(;i.test(a.charAt(s))&&s<a.length&&i.test(a.charAt(s-1));)s+=1;this._lastCursorPos=s,a=a.substring(0,s)+"\\Downarrow "+a.substring(s),a=c.START+" "+a+" "+c.END,e=M.cfg.wwwroot+"/lib/editor/atto/plugins/equation/ajax.php",n={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",text:a},r.io(e,{context:this,data:n,timeout:500,on:{complete:this._loadPreview}})},_loadPreview:function(t,e){var i=this._content.one(l.EQUATION_PREVIEW);200===e.status&&(i.setHTML(e.responseText),require(["core/event"],function(t){t.notifyFilterContentUpdated(i.getDOMNode())}))},_getDialogueContent:function(){var t=this._getLibraryContent(),e=this._throttle(this._updatePreview,500),i=r.Handlebars.compile(n);return this._content=r.Node.create(i({elementid:this.get("host").get("elementid"),component:s,library:t,texdocsurl:this.get("texdocsurl"
),CSS:u})),this._content.all(l.LIBRARY_GROUP).each(function(t){this._setGroupTabFocus(t,t.one("button")),t.all("button a").setAttribute("tabindex","-1")},this),this._content.delegate("key",this._groupNavigation,"down:37,39",l.LIBRARY_BUTTON,this),this._content.one(l.SUBMIT).on("click",this._setEquation,this),this._content.one(l.EQUATION_TEXT).on("valuechange",e,this),this._content.one(l.EQUATION_TEXT).on("mouseup",e,this),this._content.one(l.EQUATION_TEXT).on("keyup",e,this),this._content.delegate("click",this._selectLibraryItem,l.LIBRARY_BUTTON,this),this._content},_groupNavigation:function(t){t.preventDefault();var e,i=t.currentTarget,n=i.get("parentNode"),o=n.all("button"),a=37!==t.keyCode?1:-1,s=o.indexOf(i);s<0&&(s=0),(s+=a)<0?s=o.size()-1:s>=o.size()&&(s=0),e=o.item(s),this._setGroupTabFocus(n,e),e.focus()},_setGroupTabFocus:function(t,e){var i=t.generateID();"undefined"!=typeof this._groupFocus[i]&&this._groupFocus[i].setAttribute("tabindex","-1"),(this._groupFocus[i]=e).setAttribute("tabindex",0),t.setAttribute("aria-activedescendant",e.generateID())},_selectLibraryItem:function(t){var e,i,n,o,a,s=t.currentTarget.getAttribute("data-tex"),r=0;t.preventDefault(),this._setGroupTabFocus(t.currentTarget.get("parentNode"),t.currentTarget)," "!==(i=(e=(n=t.currentTarget.ancestor(".atto_form").one("textarea")).get("value")).substring(0,this._lastCursorPos)).charAt(i.length-1)&&(i+=" "),r=(i+=s).length," "!==e.charAt(this._lastCursorPos)&&(i+=" "),i+=e.substring(this._lastCursorPos,e.length),n.set("value",i),n.focus(),"number"==typeof(o=n.getDOMNode()).selectionStart?o.selectionStart=o.selectionEnd=r:"undefined"!=typeof o.createTextRange&&((a=o.createTextRange()).moveToPoint(r),a.select()),this._updatePreview(!1)},_getLibraryContent:function(){var t,e,i,n=r.Handlebars.compile(d),o=this.get("library"),a="";return r.Handlebars.registerHelper("split",function(t,e,i){var n,o,a;if(void 0===t||void 0===e)return"";for(a="",n=e.trim().split(t);0<n.length;)o=n.shift().trim(),a+=i.fn(o);return a}),a=n({elementid:this.get("host").get("elementid"),elementidescaped:this._escapeQuerySelector(this.get("host").get("elementid")),component:s,library:o,CSS:u,DELIMITERS:c}),t=M.cfg.wwwroot+"/lib/editor/atto/plugins/equation/ajax.php",e={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",text:a},200===(i=r.io(t,{sync:!0,data:e,method:"POST"})).status&&(a=i.responseText),a},_escapeQuerySelector:function(t){return t.replace(/(:|\.|\[|\]|,|=|@)/g,"\\$1")}},{ATTRS:{texfilteractive:{value:!1},contextid:{value:null},library:{value:{}},texdocsurl:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","moodle-core-event","io","event-valuechange","tabview","array-extras"]});
>>>>>>> remotes/origin/MOODLE_310_STABLE
